# 跨平台设备发现与连接技术说明

> 本文档记录 SkyBridge Compass 中设备发现与远程连接相关服务的架构关系。

## 服务架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                      UI Layer                                │
│  ┌─────────────────┐  ┌─────────────────┐                   │
│  │ AgentStatusView │  │ RemoteDesktop   │                   │
│  │ (Agent连接状态)  │  │ Views           │                   │
│  └────────┬────────┘  └────────┬────────┘                   │
└───────────┼────────────────────┼────────────────────────────┘
            │                    │
┌───────────┼────────────────────┼────────────────────────────┐
│           ▼                    ▼         Service Layer       │
│  ┌─────────────────┐  ┌─────────────────┐                   │
│  │ RemoteControl   │  │ RemoteDesktop   │                   │
│  │ ViewModel       │  │ Manager         │                   │
│  │ (Web Agent)     │  │ (RDP/VNC)       │                   │
│  └────────┬────────┘  └────────┬────────┘                   │
└───────────┼────────────────────┼────────────────────────────┘
            │                    │
┌───────────┼────────────────────┼────────────────────────────┐
│           ▼                    ▼         Core Layer          │
│  ┌─────────────────────────────────────────────────────────┐│
│  │              SignalingService (WebSocket)               ││
│  │              FileTransferSignalingService               ││
│  └─────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────┐│
│  │              HybridCrypto (PQC加密)                      ││
│  └─────────────────────────────────────────────────────────┘│
│  ┌─────────────────┐  ┌─────────────────┐                   │
│  │ BonjourService  │  │ BonjourService  │                   │
│  │ Enhanced        │  │ (原有)          │                   │
│  │ (TXT记录支持)   │  │                 │                   │
│  └─────────────────┘  └─────────────────┘                   │
└─────────────────────────────────────────────────────────────┘
```

## 服务说明

### 1. 设备发现服务

| 服务 | 文件 | 用途 | 状态 |
|------|------|------|------|
| `BonjourService` | Discovery/BonjourService.swift | 基础 Bonjour 发现 | 生产使用 |
| `BonjourServiceEnhanced` | Discovery/BonjourServiceEnhanced.swift | 增强版，支持 TXT 记录和重试 | 待集成 |
| `DeviceDiscoveryManager` | Discovery/DeviceDiscoveryManager.swift | 设备发现管理器 | 生产使用 |

**集成说明**: `BonjourServiceEnhanced` 提供了 TXT 记录解析和 10 秒重试机制，可在需要跨平台能力协商时替换原有 `BonjourService`。

### 2. 远程控制服务

| 服务 | 文件 | 用途 | 状态 |
|------|------|------|------|
| `RemoteDesktopManager` | RemoteDesktopManager.swift | RDP/VNC 远程桌面 | 生产使用 |
| `RemoteControlViewModel` | Agent/RemoteControlViewModel.swift | Web Agent 远程控制 | 待集成 |
| `SignalingService` | Agent/SignalingService.swift | WebSocket 信令 | 生产使用 |

**架构说明**:
- `RemoteDesktopManager`: 传统 RDP/VNC 协议，适用于 Windows/Linux 远程桌面
- `RemoteControlViewModel`: 基于 WebSocket 的轻量级远程控制，适用于 Web Agent 场景

两者并行存在，服务不同场景。

### 3. 文件传输服务

| 服务 | 文件 | 用途 | 状态 |
|------|------|------|------|
| `FileTransferManager` | FileTransfer/FileTransferManager.swift | 本地文件传输 | 生产使用 |
| `FileTransferSignalingService` | Agent/FileTransferSignalingService.swift | 信令层文件传输 | 生产使用 |

**架构说明**: `FileTransferSignalingService` 处理信令层的文件元数据交换，实际数据传输由 `FileTransferManager` 完成。

### 4. 加密服务

| 服务 | 文件 | 用途 | 状态 |
|------|------|------|------|
| `HybridCrypto` | Protocol/HybridCrypto.swift | X25519+ML-KEM-768 混合密钥交换 | 生产使用 |
| `PQCProtocolAdapter` | Protocol/PQCProtocolAdapter.swift | 后量子加密适配器 | 生产使用 |

## 待办事项

- [ ] 将 `AgentStatusView` 集成到 Dashboard（可选，按需启用）
- [ ] 评估 `BonjourServiceEnhanced` 替换时机

## 更新记录

| 日期 | 内容 |
|------|------|
| 2025-12-13 | 初始文档，记录服务架构关系 |
