# 登录方式技术说明（SkyBridge Compass Pro, macOS 14+）

> 说明当前已支持的登录方式、核心服务与接口、会话与存储策略，并给出为 iOS、Windows、Android、Linux 平台的落地方案与并发/安全最佳实践。本文与项目的 Swift 6.2.1 并发模型、Apple Silicon 优化保持一致，所有描述均面向真实 API，不使用模拟数据。

## 文档目标
- 明确当前支持的四类登录方式与调用路径（Apple ID、Nebula 企业登录、手机号验证码、邮箱密码）。
- 解释服务层组件职责与数据流，含会话持久化与刷新流程。
- 指导未来在 iOS、Windows、Android、Linux 上的实现方案，保证统一会话模型与安全。
- 给出并发控制与错误处理的最佳实践，避免界面线程阻塞。

## 架构概览（组件与职责）
- `AuthenticationService`（核心认证服务，@MainActor）
  - 统一入口：Apple ID、Nebula、Phone OTP、Email/Password。
  - 负责与真实后端或 Supabase 交换令牌，发布 `AuthSession` 并写入 Keychain。
  - 支持“Supabase 模式”，由 `SupabaseConfiguration` 在启动阶段启用。
- `SupabaseService`（Supabase 集成，@MainActor）
  - 调用 `auth/v1/token`、`auth/v1/otp` 等真实接口完成 Apple、邮箱、短信 OTP 登录与刷新令牌。
  - 提供用户注册、资料更新，以及保存企业 `nebula_id` 的数据接口示例。
- `NebulaService`（企业级身份系统，@MainActor）
  - 采用 JWT + OAuth2 混合模型，支持用户名/密码与多因素认证（MFA）。
  - 返回 `NebulaAuthResult`（含是否需要 MFA 与 `mfaToken`）。
- `TenantAccessController`（租户访问控制）
  - 绑定/清理认证会话，向远程桌面与文件传输等子系统提供受控凭据。
- `SupabaseConfiguration`（配置管理，@MainActor）
  - 从环境变量自动加载配置并启用 Supabase 模式。
  - 环境变量：`SUPABASE_URL`、`SUPABASE_ANON_KEY`。
- `KeychainManager`（安全存储）
  - 安全保存敏感配置（如 Nebula Client ID/Secret、Supabase 密钥等）。

## 当前支持的登录方式与真实接口
### 1) Apple ID（Sign in with Apple）
- 客户端流程（macOS 与 iOS 原生）：
  - 使用 `AuthenticationServices` 获取 `identityToken`（必要）与 `authorizationCode`（可选）。
  - 交给 `AuthenticationService.authenticateWithApple(...)` 完成换取会话。
- Supabase 模式接口：
  - `POST {SUPABASE_URL}/auth/v1/token`
  - 请求头：`Content-Type: application/json`、`Authorization: Bearer {anonKey}`、`apikey: {anonKey}`
  - 请求体示例：
    ```json
    { "provider": "apple", "id_token": "<identityToken>", "nonce": "" }
    ```
  - 成功返回：`access_token`、`refresh_token`、`user.id` 等，统一封装为 `AuthSession`。

### 2) Nebula 企业登录（用户名/密码 + 可选MFA）
- 客户端流程：
  - 通过 `AuthenticationService.authenticateWithNebula(username, password)` 调用后端 `nebula/login`。
  - 若后端返回需要 MFA：读取 `mfaToken` 并使用 `AuthenticationService.verifyNebulaMFA(mfaToken, code)` 完成验证。
- 接口路径（示例，基于 `SKYBRIDGE_AUTH_BASEURL`）：
  - 登录：`POST {BASE}/auth/nebula/login`
  - 验证MFA：`POST {BASE}/auth/nebula/login`（携带 `mfaToken` 与 `code`）
- 返回会话统一封装为 `AuthSession`，后续由 `TenantAccessController` 进行绑定。

### 3) 手机号 + 短信验证码登录（Supabase OTP）
- 发送验证码：
  - `POST {SUPABASE_URL}/auth/v1/otp`
  - 头：`Authorization: Bearer {anonKey}`、`apikey: {anonKey}`
  - 体：`{ "phone": "+86xxxxxxxxxxx" }`
- 完成登录：
  - `POST {SUPABASE_URL}/auth/v1/token`
  - 体：`{ "phone": "+86...", "token": "123456", "type": "sms", "grant_type": "otp" }`
- 客户端入口：`AuthenticationService.sendPhoneVerificationCode(...)` 与 `loginPhone(...)`。

### 4) 邮箱 + 密码登录（Supabase Password Grant）
- 接口：
  - `POST {SUPABASE_URL}/auth/v1/token?grant_type=password`
  - 头：`Authorization: Bearer {anonKey}`、`apikey: {anonKey}`
  - 体：`{ "email": "user@example.com", "password": "******" }`
- 客户端入口：`AuthenticationService.loginEmail(email, password)`。

### 令牌刷新（统一会话续期）
- 接口：
  - `POST {SUPABASE_URL}/auth/v1/token`
  - 体：`{ "grant_type": "refresh_token", "refresh_token": "..." }`
- 客户端入口：`SupabaseService.refreshAccessToken(refreshToken)`，刷新成功同样产出 `AuthSession`。

## 会话与存储策略
- 会话模型：`AuthSession { accessToken, refreshToken?, userIdentifier, displayName, issuedAt }`
- 存储位置：
  - macOS/iOS：Keychain（服务名 `com.skybridge.compass.authsession`，避免明文磁盘存储）。
  - 租户密码与远程桌面凭据同样通过 Keychain 管理（见 `TenantAccessController`）。
- 发布机制：`AuthenticationService.sessionPublisher` 使用 Combine 将会话变更推送到 UI 层，所有更新在主线程进行。

## 启动与配置
- 应用启动后：
  - `SupabaseConfiguration` 尝试从环境变量读取配置，成功则启用“Supabase 模式”。
  - 代码参考：`SkyBridgeCompassApp` 中的 `.task { AuthenticationService.shared.enableSupabaseMode(...) }`。
- 必需环境变量：
  - `SUPABASE_URL`：Supabase 项目地址，如 `https://xxx.supabase.co`。
  - `SUPABASE_ANON_KEY`：匿名访问密钥（客户端使用）。
- 可选环境变量：
  - `SKYBRIDGE_AUTH_BASEURL`：指向自建后端，覆盖默认接口路径（Nebula 或私有认证）。

## 并发与错误处理最佳实践（Swift 6.2.1）
- 所有认证服务类标注为 `@MainActor`，UI 变更通过主线程发布，避免“视图更新期间修改状态”的未定义行为。
- 网络调用使用 `URLSession` + `async/await`，配置 `waitsForConnectivity = true`，合理的请求/资源超时（参考项目中 10s/30s）。
- 涉及 UI 的状态更新使用 `Task { @MainActor in ... }` 或 `MainActor.run { ... }`，避免跨 actor 读写。
- 避免阻塞主线程：所有重网络/IO 操作在异步上下文执行，UI 层仅订阅 `sessionPublisher`。
- 错误分类：配置缺失（`configurationMissing`）、网络错误、认证失败、响应解析失败，统一转中文错误文案。

## 跨平台落地方案
为保证统一体验，建议在各平台以“统一会话模型 + 统一接口调用”实现，差异仅在获取凭据与安全存储层。

### iOS
- Apple 登录：使用 `ASAuthorizationAppleIDProvider` 与 `ASAuthorizationController` 获取 `identityToken`，调用 `AuthenticationService.authenticateWithApple(...)`。
- 邮箱/手机号：直接调用 Supabase 接口（`auth/v1/token`、`auth/v1/otp`）。
- Nebula：优先走 OAuth2/Web SSO（`ASWebAuthenticationSession`），返回 `code` 或 `id_token` 后走后端交换，或直接命中项目现有的 Nebula REST 入口。
- 安全存储：Keychain（与 macOS 统一会话结构）。
- 并发：`@MainActor` 的 ViewModel，异步任务更新 UI；不要在 `View.body` 中做同步网络操作。

### Windows
- Apple 登录：使用 WebView2 + Sign in with Apple 的 Web OAuth 流程，拿到 `id_token` 后调用 Supabase `auth/v1/token` 的 `provider=apple` 分支。
- 邮箱/手机号：直接使用 Supabase 接口。
- Nebula：浏览器内 OAuth2 或用户名/密码 REST 登录，若返回 `mfaToken` 则弹出二次验证。
- 安全存储：DPAPI（`CryptProtectData`/`CryptUnprotectData`）保存会话。
- 并发：基于 .NET Task 异步，不阻塞 UI 线程；同样保持统一的会话刷新策略。

### Android
- Apple 登录：走 Web OAuth（AppAuth 或 Chrome Custom Tabs），获取 `id_token` 后调用 Supabase。
- 邮箱/手机号：Supabase 接口；短信自动填充可用，但避免强依赖，保障手动输入路径畅通。
- Nebula：AppAuth OAuth2 / REST 登录 + MFA 验证。
- 安全存储：Android Keystore + EncryptedSharedPreferences 保存会话与刷新令牌。
- 并发：Kotlin Coroutines/Flow 驱动 UI；网络与 IO 在 `Dispatchers.IO`，UI 在 `Main`。

### Linux（桌面）
- Apple 登录：浏览器 Web OAuth，回调到本地 Loopback（`http://127.0.0.1:<port>/callback`）或自定义 Scheme（`skybridge://auth/callback`），拿到 `id_token` 后调用 Supabase。
- 邮箱/手机号：Supabase 接口统一实现。
- Nebula：REST/OAuth2 登录 + MFA。
- 安全存储：`libsecret`（GNOME Keyring）或 `kwallet`，避免明文文件存储。
- 并发：事件循环/协程库（如 QtConcurrent、Boost.Asio、Kotlin/Compose Multiplatform），保持 UI 非阻塞。

## MFA 与安全要点
- Nebula：登录可能返回 `mfaRequired = true` 与 `mfaToken`，客户端弹出验证码输入框后调用 `verifyNebulaMFA(...)`；MFA 失败要清理中间状态。
- 令牌刷新：统一使用 `SupabaseService.refreshAccessToken(...)`，失败时退出会话并提示用户重新登录。
- 密钥管理：`APIKeyManagementView` 提供 UI 管理 Supabase 与 Nebula 的密钥/配置，内部通过 Keychain 安全存储。
- 隐私最小化：本地仅保存会话必需数据，所有日志避免打印完整令牌与账号信息。

## 统一接口与会话模型（跨平台建议）
- 接口统一：所有平台调用同一组真实接口（Supabase 与/或自建后端），通过平台适配层只负责“获取凭据”。
- 会话统一：各平台产出相同 `AuthSession` 结构，以便设备发现、文件传输、远程桌面等子系统共享认证状态。
- 失败重试：网络错误采用指数退避，避免过快重试造成限流；刷新令牌失败立即降级为登出。

## 测试建议
- 单元测试：对 `AuthenticationService` 的各入口进行成功/失败路径测试，覆盖 Supabase 模式与自建后端模式。
- 集成测试：模拟 OTP 发送与登录流程；Nebula 的 MFA 流程校验分支覆盖率。
- 并发测试：高并发下的会话刷新与 UI 订阅，不应出现跨 actor 读写问题与界面阻塞。

## 版本兼容与演进
- 平台最低版本：macOS 14.0（文档与实现遵循最新 Apple API）。
- 未来扩展：Passkeys/WebAuthn、更多 OAuth 提供方（GitHub/Google/Microsoft）、TOTP（基于 RFC 6238），保持与 Supabase 的 Provider 能力对齐。
- 重构方向：跨平台统一“凭据获取 + 会话交换”的接口，确保模块化与可测试性。

---

如需开启 Supabase 模式，请在环境中设置：
```
export SUPABASE_URL="https://your-project.supabase.co"
export SUPABASE_ANON_KEY="your-anon-key"
```
如需指向自建后端（Nebula/私有认证），请设置：
```
export SKYBRIDGE_AUTH_BASEURL="https://auth.skybridge.example"
```
以上配置会在启动阶段被 `SupabaseConfiguration` 与 `AuthenticationService` 读取，随后启用相应认证路径。